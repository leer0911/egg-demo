# JWT

JSON Web Token (JWT) 是一个非常轻巧的规范。这个规范允许我们使用 JWT 在用户和服务器之间传递安全可靠的信息。

## JWT 组成

一个 JWT 实际上就是一个字符串，它由三部分组成，头部，载荷和签名。

### Header

头部用于描述该 JWT 的最基本的信息，例如其类型以及签名所用的算法等。

```json
{
  "typ": "JWT",
  "alg": "HS256"
}
```

将上面的 JSON 对象进行 **base64 编码** 得到的字符串就称为 JWT 的 **Header** (头部)。

### Payload

```json
{
  "iss": "该 JWT 的签发者",
  "sub": "该 JWT 所面向的用户",
  "aud": "接收该 JWT 的一方",
  "exp": "过期时间，Unix 时间戳",
  "iat": "签发时间"
}
```

将上面的 JSON 对象进行 **base64 编码** 得到的字符串就称为 JWT 的 **Payload** (载荷)。

### Signature

将上面两个编码后的字符串都用句号 . 链接在一起 (头部在前)，并且用 HS256 算法进行加密，与此同时，我们还需要提供一个密钥 (secret)。这部分就称为 **签名** 。

- 实际上是对头部以及载荷内容进行签名

- 在 JWT 中，不应该在载荷里面加入任何敏感数据。

## JWT 使用场景

可用于向 web 应用传递一些非敏感信息。例如，加好友，下订单。还可以用于设计用户认证和授权系统。

### 用户认证

所谓用户认证 ( Authentication )，就是让用户登录，并且在接下来的一段时间内让用户访问网站时无需再次登录的机制。

> 用户认证和用户授权 (Authorization) 不一样，用户授权指的是规定并允许用户使用自己的权限，例如发布帖自动化管理站点等。

- 用户通过 web 表单将自己的用户名和密码发送到服务器。一般是 POST 请求，建议的方式是通过 SSL 加密的传输 (https 协议)，从而避免敏感信息被嗅探。
- 验证用户名与密码，成功后应用将用户的 id 作为 JWT Payload 的一个属性，将其与头部分别进行 Base64 编码拼接后签名，形成一个 JWT。
- 以 `set-Cookie:jwt=...;HttpOnly;max-age=...` cookie 的形式返回给用户，HttpOnly 用于避免 CSRF。
- 从 cookie 中提取 JWT，验证 JWT 的有效性。例如，检查签名是否正确，检查 Token 是否过期，检查 Token 的接收方是否是自己 (可选)。
- 确认 JWT 有效之后进行 Base64 解码，然后在 Payload 中读取用户的 id。

`Session` 方式存储用户 id 最大的弊端在于要占用大量服务器内存，JWT 方式将用户状态分散到了客户端中，可以明显减轻服务端的内存压力。

### 单点登录

只需要将含有 JWT 的 Cookie 的 domain 设置为顶级域名即可：

`set-Cookie：jwt=....;HttpOnly;max-age=980000;domain=.taobao.com`
